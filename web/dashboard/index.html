<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NanoLambda Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f4f6f8; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { color: #333; }
        h2 { color: #666; font-size: 1.2em; margin-top: 0; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-item { text-align: center; }
        .stat-value { font-size: 2em; font-weight: bold; color: #0070f3; }
        .stat-label { color: #888; }
        canvas { width: 100% !important; height: 300px !important; }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>âš¡ NanoLambda Dashboard</h1>
            <span style="color: #666;">Live Metrics</span>
        </div>

        <div class="stats-grid">
            <div class="card stat-item">
                <div class="stat-value" id="totalRequests">-</div>
                <div class="stat-label">Total Requests</div>
            </div>
            <div class="card stat-item">
                <div class="stat-value" id="activeContainers">-</div>
                <div class="stat-label">Active Containers</div>
            </div>
             <div class="card stat-item">
                <div class="stat-value" id="aiPredictions">-</div>
                <div class="stat-label">AI Predictions</div>
            </div>
        </div>

        <div class="card">
            <h2>Traffic Real-time (Last 5 min)</h2>
            <canvas id="trafficChart"></canvas>
        </div>
    </div>

    <script>
        const PROMETHEUS_URL = 'http://localhost:9090'; 
        // Note: This requires Prometheus to have CORS enabled or be proxied. 
        // For this demo, we assume browser can reach localhost:9090.
        // If CORS is blocked, we might need a simple proxy in serve.py.

        async function queryPrometheus(query) {
            try {
                const response = await fetch(`${PROMETHEUS_URL}/api/v1/query?query=${encodeURIComponent(query)}`);
                const data = await response.json();
                return data.data.result;
            } catch (e) {
                console.error("Prometheus fetch error:", e);
                return [];
            }
        }

        async function updateStats() {
            // 1. Total Requests
            const reqs = await queryPrometheus('sum(http_requests_total)');
            if (reqs.length > 0) {
                document.getElementById('totalRequests').innerText = reqs[0].value[1];
            }

            // 2. Mock Active Containers (Real implementation would query Docker or Gateway API)
            // We'll use a random number for demo "liveness" if no metric
            document.getElementById('activeContainers').innerText = Math.floor(Math.random() * 3);

            // 3. Mock AI Predictions
            document.getElementById('aiPredictions').innerText = "12";
        }

        // Chart Setup
        const ctx = document.getElementById('trafficChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Requests/sec',
                    data: [],
                    borderColor: '#0070f3',
                    tension: 0.4,
                    fill: true,
                    backgroundColor: 'rgba(0, 112, 243, 0.1)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                },
                animation: false
            }
        });

        async function updateChart() {
            // Query rate for last 5 minutes
            // rate(http_requests_total[1m])
            const data = await queryPrometheus('rate(http_requests_total[1m])');
            
            const now = new Date();
            const timeLabel = now.getHours() + ":" + now.getMinutes() + ":" + now.getSeconds();

            if (chart.data.labels.length > 20) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }

            chart.data.labels.push(timeLabel);
            
            let val = 0;
            if (data.length > 0) {
                val = parseFloat(data[0].value[1]);
            }
            chart.data.datasets[0].data.push(val);
            chart.update();
        }

        setInterval(() => {
            updateStats();
            updateChart();
        }, 2000);
        
        updateStats();
        updateChart();
    </script>
</body>
</html>
